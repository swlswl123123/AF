%% 100MHz BPSK/QPSK/16QAM.
close   all;
clear;
j      = 1i;
%% parameters
Ts     = 1/100e6;         % 100MHz
M      = 16;              % 2:BPSK 4:QPSK 16:QAM
Nlen   = 40;              % 33. OFDM data symbols number.

SNR    = 22:1:22;         % dB.
N_FFT  = 512;             % 64 fft.
deltaf = 0;               % cfo.
%% 
%f = [-3.57991155196924e-19,-0.000282649394796115,-0.000525791965429469,-0.000475416983723193,9.27260273505974e-19,0.000731628527240472,0.00125463273086795,0.00106307976671378,-1.74728057609040e-18,-0.00148301296094593,-0.00244770849279972,-0.00200653136531637,2.80355925724936e-18,0.00265127251920136,0.00427878875724403,0.00343848976765794,-4.04598809559076e-18,-0.00439479131278936,-0.00699581925273953,-0.00555497139192494,5.39120766187575e-18,0.00696672908988022,0.0110128710249591,0.00869881368759028,-6.73063978364705e-18,-0.0108557716105287,-0.0171721337464203,-0.0136063727671956,7.94324573649579e-18,0.0172430846995437,0.0276474325182314,0.0223208371330115,-8.91116413941195e-18,-0.0300335875386367,-0.0504711057057638,-0.0434944357428851,9.53578335605530e-18,0.0741357049010938,0.158369021719968,0.224908142752552,0.250159141272278,0.224908142752552,0.158369021719968,0.0741357049010938,9.53578335605530e-18,-0.0434944357428851,-0.0504711057057638,-0.0300335875386367,-8.91116413941195e-18,0.0223208371330115,0.0276474325182314,0.0172430846995437,7.94324573649579e-18,-0.0136063727671956,-0.0171721337464203,-0.0108557716105287,-6.73063978364705e-18,0.00869881368759028,0.0110128710249591,0.00696672908988022,5.39120766187575e-18,-0.00555497139192494,-0.00699581925273953,-0.00439479131278936,-4.04598809559076e-18,0.00343848976765794,0.00427878875724403,0.00265127251920136,2.80355925724936e-18,-0.00200653136531637,-0.00244770849279972,-0.00148301296094593,-1.74728057609040e-18,0.00106307976671378,0.00125463273086795,0.000731628527240472,9.27260273505974e-19,-0.000475416983723193,-0.000525791965429469,-0.000282649394796115,-3.57991155196924e-19];
f = [-0.000352165864087315,0.000293233006890745,0.000256111189467333,0.000218268786408666,0.000148472460684557,5.21782860502409e-05,-3.70774112593373e-05,-8.03160482225670e-05,-5.90590967225926e-05,1.08179353678852e-05,8.53412074788136e-05,0.000116752405616910,8.15080926231906e-05,-4.13154323661089e-06,-9.19361674835859e-05,-0.000128995934302586,-8.98501241682737e-05,6.49003283876800e-06,0.000105062810946001,0.000146293091979427,0.000101599479997064,-7.17236741322669e-06,-0.000118187773678988,-0.000164421715981808,-0.000114162935944828,7.96272507152208e-06,0.000132350208939782,0.000184140949809812,0.000127855581344147,-8.62383676394737e-06,-0.000147614505276179,-0.000205403638904842,-0.000142750066146437,9.31854841836135e-06,0.000163997342548054,0.000228374449815817,0.000158735357384098,-1.00144913191977e-05,-0.000181679410791044,-0.000252970942225656,-0.000175962542599132,1.08382144582369e-05,0.000200495436840861,0.000279425963131528,0.000194325172565831,-1.14143483665742e-05,-0.000220809594179253,-0.000307552428697385,-0.000214328172880618,1.19540411801044e-05,0.000242610847564032,0.000338122444292645,0.000235532147599619,-1.31234181320828e-05,-0.000265440590050429,-0.000370541872740590,-0.000258332860877148,1.37851039516208e-05,0.000290138801833465,0.000405138400769372,0.000282693473049047,-1.46060525536164e-05,-0.000316354377106242,-0.000442082714070856,-0.000308636058694322,1.53596645532920e-05,0.000344296646060949,0.000481376124684699,0.000336330390905431,-1.61891398539711e-05,-0.000373983418219673,-0.000523231917982146,-0.000365767347023438,1.70204750318093e-05,0.000405597003241189,0.000567725177683616,0.000397135525090270,-1.78958789692616e-05,-0.000439148174233725,-0.000615067202093379,-0.000430490533182581,1.87481371570599e-05,0.000474814330051457,0.000665380843006270,0.000466028037339820,-1.96064015956887e-05,-0.000512629821602452,-0.000718818047659620,-0.000503753973598288,2.04675165532031e-05,0.000552745970811456,0.000775474406311554,0.000543805230308644,-2.13727769529840e-05,-0.000595191431519617,-0.000835635241656640,-0.000586234136969696,2.22012835851659e-05,0.000640289782882116,0.000899426574178686,0.000631463017283963,-2.32132152315136e-05,-0.000688152674996543,-0.000967069423209464,-0.000679354081365496,2.40972457674508e-05,0.000738855950282079,0.00103892114139896,0.000730295264895379,-2.49824263087163e-05,-0.000792536174737325,-0.00111509624051258,-0.000784321989746916,2.58577130249830e-05,0.000849474675376876,0.00119590156156977,0.000841704257438730,-2.67713772253624e-05,-0.000909885266012545,-0.00128172401407702,-0.000902640644556681,2.76998619082864e-05,0.000974078407135969,0.00137293264347951,0.000967495859565290,-2.86075994392201e-05,-0.00104221471132481,-0.00146990275660521,-0.00103650720630349,2.94349078491950e-05,0.00111458415349492,0.00157297017844163,0.00110992746900644,-3.03510945895677e-05,-0.00119166055060866,-0.00168283025995302,-0.00118819449326459,3.12574162928035e-05,0.00127386199548966,0.00180000999997146,0.00127182568847739,-3.21490820799478e-05,-0.00136147224616879,-0.00192514568626991,-0.00136120144793177,3.29697055857974e-05,0.00145506237124802,0.00205894051180268,0.00145685960110859,-3.38046882069630e-05,-0.00155537464062978,-0.00220240411854441,-0.00155946128329193,3.46801814334149e-05,0.00166300327563999,0.00235656446613741,0.00166993398523637,-3.54438112083464e-05,-0.00177869628786305,-0.00252248774447487,-0.00178894075379869,3.62365825528097e-05,0.00190353385546523,0.00270169164795481,0.00191761707235939,-3.70565186859312e-05,-0.00203868104505436,-0.00289597062362371,-0.00205733780004828,3.77285487243598e-05,0.00218533187139874,0.00310712695824131,0.00220940877634040,-3.84513326939493e-05,-0.00234528026960548,-0.00333772030690518,-0.00237568618007848,3.91976464483969e-05,0.00252056987188578,0.00359080625142543,0.00255854891408216,-3.97921541225812e-05,-0.00271341461391459,-0.00386983624437208,-0.00276045866121879,4.04705469148453e-05,0.00292713985294128,0.00417956112239998,0.00298502402395002,-4.10935302219274e-05,-0.00316543715971614,-0.00452562439634663,-0.00323651772222187,4.16335748080805e-05,0.00343306955144875,0.00491526376176811,0.00352030981487628,-4.22467909597981e-05,-0.00373652480093610,-0.00535821252954508,-0.00384383279073413,4.27155133607656e-05,0.00408383771667275,0.00586669063889911,0.00421636172201494,-4.32795748207557e-05,-0.00448634678081660,-0.00645796322481383,-0.00465109713806493,4.36727977952912e-05,0.00495899813556705,0.00715513338973755,0.00516583138235977,-4.41377577824532e-05,-0.00552346036568451,-0.00799164646560965,-0.00578652795670895,4.44979784472810e-05,0.00621092250159618,0.00901631472980251,0.00655144482252995,-4.48413354830796e-05,-0.00706889241119104,-0.0103042393106663,-0.00752008673495582,4.51324187881534e-05,0.00817298601655984,0.0119766091069677,0.00879007013343861,-4.54041898639975e-05,-0.00965143316595337,-0.0142429217203638,-0.0105334079525619,4.56034395294003e-05,0.0117404796696059,0.0174988203551593,0.0130839629767113,-4.57696145928793e-05,-0.0149284611269785,-0.0225922388220007,-0.0171866099933996,4.59104637700827e-05,0.0204140334743451,0.0317278633813612,0.0249106147884922,-4.60236742470455e-05,-0.0321356209394057,-0.0529897291450398,-0.0449467583846125,4.60673734781089e-05,0.0750370497852019,0.159134298978340,0.225039209145090,0.249953934181039,0.225039209145090,0.159134298978340,0.0750370497852019,4.60673734781089e-05,-0.0449467583846125,-0.0529897291450398,-0.0321356209394057,-4.60236742470455e-05,0.0249106147884922,0.0317278633813612,0.0204140334743451,4.59104637700827e-05,-0.0171866099933996,-0.0225922388220007,-0.0149284611269785,-4.57696145928793e-05,0.0130839629767113,0.0174988203551593,0.0117404796696059,4.56034395294003e-05,-0.0105334079525619,-0.0142429217203638,-0.00965143316595337,-4.54041898639975e-05,0.00879007013343861,0.0119766091069677,0.00817298601655984,4.51324187881534e-05,-0.00752008673495582,-0.0103042393106663,-0.00706889241119104,-4.48413354830796e-05,0.00655144482252995,0.00901631472980251,0.00621092250159618,4.44979784472810e-05,-0.00578652795670895,-0.00799164646560965,-0.00552346036568451,-4.41377577824532e-05,0.00516583138235977,0.00715513338973755,0.00495899813556705,4.36727977952912e-05,-0.00465109713806493,-0.00645796322481383,-0.00448634678081660,-4.32795748207557e-05,0.00421636172201494,0.00586669063889911,0.00408383771667275,4.27155133607656e-05,-0.00384383279073413,-0.00535821252954508,-0.00373652480093610,-4.22467909597981e-05,0.00352030981487628,0.00491526376176811,0.00343306955144875,4.16335748080805e-05,-0.00323651772222187,-0.00452562439634663,-0.00316543715971614,-4.10935302219274e-05,0.00298502402395002,0.00417956112239998,0.00292713985294128,4.04705469148453e-05,-0.00276045866121879,-0.00386983624437208,-0.00271341461391459,-3.97921541225812e-05,0.00255854891408216,0.00359080625142543,0.00252056987188578,3.91976464483969e-05,-0.00237568618007848,-0.00333772030690518,-0.00234528026960548,-3.84513326939493e-05,0.00220940877634040,0.00310712695824131,0.00218533187139874,3.77285487243598e-05,-0.00205733780004828,-0.00289597062362371,-0.00203868104505436,-3.70565186859312e-05,0.00191761707235939,0.00270169164795481,0.00190353385546523,3.62365825528097e-05,-0.00178894075379869,-0.00252248774447487,-0.00177869628786305,-3.54438112083464e-05,0.00166993398523637,0.00235656446613741,0.00166300327563999,3.46801814334149e-05,-0.00155946128329193,-0.00220240411854441,-0.00155537464062978,-3.38046882069630e-05,0.00145685960110859,0.00205894051180268,0.00145506237124802,3.29697055857974e-05,-0.00136120144793177,-0.00192514568626991,-0.00136147224616879,-3.21490820799478e-05,0.00127182568847739,0.00180000999997146,0.00127386199548966,3.12574162928035e-05,-0.00118819449326459,-0.00168283025995302,-0.00119166055060866,-3.03510945895677e-05,0.00110992746900644,0.00157297017844163,0.00111458415349492,2.94349078491950e-05,-0.00103650720630349,-0.00146990275660521,-0.00104221471132481,-2.86075994392201e-05,0.000967495859565290,0.00137293264347951,0.000974078407135969,2.76998619082864e-05,-0.000902640644556681,-0.00128172401407702,-0.000909885266012545,-2.67713772253624e-05,0.000841704257438730,0.00119590156156977,0.000849474675376876,2.58577130249830e-05,-0.000784321989746916,-0.00111509624051258,-0.000792536174737325,-2.49824263087163e-05,0.000730295264895379,0.00103892114139896,0.000738855950282079,2.40972457674508e-05,-0.000679354081365496,-0.000967069423209464,-0.000688152674996543,-2.32132152315136e-05,0.000631463017283963,0.000899426574178686,0.000640289782882116,2.22012835851659e-05,-0.000586234136969696,-0.000835635241656640,-0.000595191431519617,-2.13727769529840e-05,0.000543805230308644,0.000775474406311554,0.000552745970811456,2.04675165532031e-05,-0.000503753973598288,-0.000718818047659620,-0.000512629821602452,-1.96064015956887e-05,0.000466028037339820,0.000665380843006270,0.000474814330051457,1.87481371570599e-05,-0.000430490533182581,-0.000615067202093379,-0.000439148174233725,-1.78958789692616e-05,0.000397135525090270,0.000567725177683616,0.000405597003241189,1.70204750318093e-05,-0.000365767347023438,-0.000523231917982146,-0.000373983418219673,-1.61891398539711e-05,0.000336330390905431,0.000481376124684699,0.000344296646060949,1.53596645532920e-05,-0.000308636058694322,-0.000442082714070856,-0.000316354377106242,-1.46060525536164e-05,0.000282693473049047,0.000405138400769372,0.000290138801833465,1.37851039516208e-05,-0.000258332860877148,-0.000370541872740590,-0.000265440590050429,-1.31234181320828e-05,0.000235532147599619,0.000338122444292645,0.000242610847564032,1.19540411801044e-05,-0.000214328172880618,-0.000307552428697385,-0.000220809594179253,-1.14143483665742e-05,0.000194325172565831,0.000279425963131528,0.000200495436840861,1.08382144582369e-05,-0.000175962542599132,-0.000252970942225656,-0.000181679410791044,-1.00144913191977e-05,0.000158735357384098,0.000228374449815817,0.000163997342548054,9.31854841836135e-06,-0.000142750066146437,-0.000205403638904842,-0.000147614505276179,-8.62383676394737e-06,0.000127855581344147,0.000184140949809812,0.000132350208939782,7.96272507152208e-06,-0.000114162935944828,-0.000164421715981808,-0.000118187773678988,-7.17236741322669e-06,0.000101599479997064,0.000146293091979427,0.000105062810946001,6.49003283876800e-06,-8.98501241682737e-05,-0.000128995934302586,-9.19361674835859e-05,-4.13154323661089e-06,8.15080926231906e-05,0.000116752405616910,8.53412074788136e-05,1.08179353678852e-05,-5.90590967225926e-05,-8.03160482225670e-05,-3.70774112593373e-05,5.21782860502409e-05,0.000148472460684557,0.000218268786408666,0.000256111189467333,0.000293233006890745,-0.000352165864087315];
pilot    = [1,1,1,-1, 1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1];
pilotpos = [-248, -232, -216, -200, -184, -168, -152, -136, -120, -104, -88, -72, -56, -40, -24,	-8, 8, 24, 40,	56, 72, 88, 104, 120, 136,	152, 168, 184, 200, 216, 232, 248] + 257;
po       = [1,1,1,1,  -1,-1,-1,-1,  -1,-1,-1,-1,  1,1,-1,1, -1,-1,1,1,  -1,1,1,-1,  1,1,1,1,  1,1,-1,1, 1,1,-1,1,  1,-1,-1,1,   1,1,-1,1,  -1,-1,-1,1,  -1,1,-1,-1,  1,-1,-1,1,  1,1,1,1,  -1,-1,1,1, -1,-1,1,-1,  1,-1,1,1,  -1,-1,-1,1,  1,-1,-1,-1,  -1,1,-1,-1,  1,-1,1,1,  1,1,-1,1,  -1,1,-1,1, -1,-1,-1,-1,  -1,1,-1,1,  1,-1,1,-1,  1,1,1,-1,  -1,1,-1,-1,  -1,1,1,1,  -1,-1,-1,-1,  -1,-1,-1];
L_k      = [-1,-1,1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,1,-1,-1,1,-1,-1,-1,-1,1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,-1,1,-1,1,-1,1,-1,1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,-1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,-1,1,-1,1,-1,1,-1,1,-1,-1,1,1,1,1,1,-1,1,1,1,1,1,1,1,-1,-1,1,1,-1,-1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1,-1,1,1,1,-1,1,-1,1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,1,1,-1,-1,-1,-1,-1,0,1,1,1,-1,1,-1,-1,-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,1,1,1,-1,-1,1,-1,-1,1,1,-1,-1,-1,1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,1,-1,1,-1,1,-1,1,1,1,1,1,1,-1,1,-1,1,1,1,1,1,1,-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,1,-1,1,1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,1,1,1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,1,1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,-1,1,1,1,-1,-1,1,1,1,-1,-1,-1,-1,1,1,-1,-1,1,1,1,-1,1,1,1,1,1,-1,1,1,-1,1,-1,1,1,1,-1,-1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,1,1,-1];
virtual_subcarrier = zeros(1,N_FFT-length(L_k));                                       % [1x13]
Long_preamble_slot_Frequency = [virtual_subcarrier(1:7),L_k,virtual_subcarrier(8:13)]; % [1x512]

%tmp = fft(Long_preamble_slot_Frequency);
%plot(abs(tmp));
%figure;
Long_preamble_slot_Time = ifft(ifftshift(Long_preamble_slot_Frequency)); 
Long_preamble = [Long_preamble_slot_Time(385:512),Long_preamble_slot_Time,Long_preamble_slot_Time]; % [1x160]
%%
factor = 1;

if M == 4
    factor = sqrt(2);
elseif M == 16
    factor = sqrt(10);
end

ber0      = zeros(1,length(SNR));
cyclenum  = 1; % bertest.
%%
for ii = 1:1:length(SNR)
    err0 = 0;
    SNR(ii)
    %Long_preamble_slot_Frequency1 = awgn(Long_preamble_slot_Frequency,SNR(ii),'measured');
    %Long_preamble_slot_Time1 = ifft(ifftshift(Long_preamble_slot_Frequency1)); 
    %Long_preamble = [Long_preamble_slot_Time1(385:512),Long_preamble_slot_Time1,Long_preamble_slot_Time1]; % [1x160]
    for cycle = 1:1:cyclenum
        cycle
        data                          = randi(M,[1,Nlen*466])-1;
        data_Freq                     = qammod(data,M)/factor;
        data_payload                  = [];
        nodatapos                     = [257,pilotpos,1:1:7,512-5:1:512];
        datapos                       = setdiff(1:1:512,nodatapos);
        for i=1:1:Nlen
            pit                           = pilot*po(1+mod(i-1,127));
            data_slot_Frequency           = zeros(1,512);
            data1_slot_Frequency          = data_Freq((i-1)*466+1:i*466);
            data_slot_Frequency(pilotpos) = pit;    
            data_slot_Frequency(datapos)  = data1_slot_Frequency;
            %data_slot_Frequency           = awgn(data_slot_Frequency,SNR(ii),'measured');
            data_slot_Time                = ifft(ifftshift(data_slot_Frequency));        % [1x512]
            data_TX_payload               = [data_slot_Time(512-63:512),data_slot_Time]; % [1x640]
            data_payload                  = [data_payload,data_TX_payload];
        end
        
        Frame = [Long_preamble,data_payload];
        %Frame = awgn(Frame,SNR(ii),'measured');
        
        signalp   = mean(abs(Frame).^2);
        
        np        = signalp / (10^(SNR(ii)/10));
        
        noise     = sqrt(np/2)*randn(1,length(Frame)) + j*sqrt(np/2)*randn(1,length(Frame));
        
        Frame     = Frame + noise;
        
        %plot(abs(Frame));
        %figure;

        %10*log10(max(abs(Frame).^2)/mean(abs(Frame).^2))

        OVR       = 4;

        %Frame_up4 = oversamp(Frame,length(Frame),OVR);

        Frame_up4 = zeros(1,length(Frame)*OVR);
        Frame_up4(1:OVR:1+OVR*(length(Frame)-1)) = Frame;

        %[Spectrum_waveform,Welch_Spectrum_frequency] = pwelch(Frame_up4,[],[],[],(1/Ts)*4,'centered','power');
        %plot(Welch_Spectrum_frequency,pow2db(Spectrum_waveform));
        %title('Spectral Density');

        %%

        RX_tmp    = conv(Frame_up4,4*f);                 % [1x972]

        fir0      = [1.0,0.2,0.2,0.2,0.2,0,0.0,0.0,0.2,0.2,0.1,0.0,0.1,0.1,0.1,0,0,0,0,0,0.0,0.0];

        %RX_tmp    = conv(RX_tmp,fir0);

        tt        = 0:1:length(RX_tmp)-1;

        %RX_tmp    = awgn(RX_tmp,SNR(ii),'measured');
        RX_tmp    = RX_tmp.*(exp(j*2*pi*deltaf*tt*Ts/4));
        %%
        RX_signal = conv(RX_tmp,4*f); % []
        RX        = RX_signal; % store
        %% packet detection.
        Threshold = 8;
        CL = [];
        PL = [];
        for i = 1:length(RX_signal)-2044
            CL(i) = Long_preamble_slot_Time*RX_signal(i:4:i+511*4)';
            PL(i) = sum(abs(Long_preamble_slot_Time).^2);
        end
        CLP       = (abs(CL).^2)./(PL.^2);
        %plot(CLP);
        loc       = find(CLP>Threshold);
        [~,iLP1]  = max(CLP(loc(1):loc(1)+511));
        [~,iLP2]  = max(CLP(loc(1)+512:loc(1)+512+2048));
        iLP2      = iLP2 + 512;
        dif       = iLP2 - iLP1;
        if dif >= 2044 && dif <= 2052
            %'packet detected!'
            lpindex = loc(1) + iLP1 - 1;
        else
            error('no packet detected!')
        end
        %%
        RX_signal        = RX_signal(lpindex:4:end);
        z                = RX_signal(1:512)*RX_signal(513:1024)';                      
        f_est            = (-1/(2*pi*512*Ts))*angle(z);
        %Framerx          = RX_signal;
        Framerx          = RX_signal.*exp(-j*2*pi*f_est*Ts*(0:1:length(RX_signal)-1));
        %%
        Long_preamble_1           = Framerx(1:512);                          % [1x512]
        Long_preamble_2           = Framerx(513:1024);                       % [1x512]
        Long_preamble_1_After_FFT = fftshift(fft(Long_preamble_1));          % [1x512]
        Long_preamble_2_After_FFT = fftshift(fft(Long_preamble_2));          % [1x512]
        H_est = 0.5*(Long_preamble_1_After_FFT+Long_preamble_2_After_FFT).*((Long_preamble_slot_Frequency)); % [1x64]
        H_e = zeros(1,512);
        H_e([8:256,258:end-6]) = smoothdata(H_est([8:256,258:end-6]),'movmean', 40);
        %%
        RX_payload       =   [];
        RX_no_Equalizer  =   [];
        delta            =   [];
        Framerx = Framerx(1025:end);

        for i=1:1:Nlen
            RX_Payload_time                = Framerx(576*(i-1)+1:576*i);      % [1x640]
            RX_Payload_no_CP               = RX_Payload_time(65:576);        % [1x512]
            RX_Payload_Frequency           = fftshift(fft(RX_Payload_no_CP)); % [1x512]
            %RX_Payload_Frequency_Equalizer = RX_Payload_Frequency;
            RX_Payload_Frequency_Equalizer = RX_Payload_Frequency./H_e;     % [1x512]
            %%
            pit    = pilot*po(1+mod(i-1,127));
            pilotr = pit.*RX_Payload_Frequency_Equalizer(pilotpos);
            pc     = angle(sum(pilotr));

            RX_Payload_Frequency_Equalizer = RX_Payload_Frequency_Equalizer*exp(-j*pc);
            RX_Payload_no_Equalizer        = RX_Payload_Frequency(datapos);             %[1x472]
            RX_Payload_no_pilot            = RX_Payload_Frequency_Equalizer(datapos);   %[1x472]
            RX_no_Equalizer                = [RX_no_Equalizer RX_Payload_no_Equalizer];
            RX_payload                     = [RX_payload RX_Payload_no_pilot];
        end
        RX_data = qamdemod(factor*RX_payload,M); 
        %% BER calculation
        [bit0,BER] = biterr(data,RX_data,log2(M));
        err0 = err0 + bit0;
    end
    ber0(ii) = err0 / (cyclenum*length(data)*log2(M));
end

%% Plot
%% Plot
figure;
subplot(2,3,1),plot(complex(data_Freq),'*r');
title('TX');axis([-1.5 1.5 -1.5 1.5]);
subplot(2,3,2),plot(CLP); title('packet detection');
%--------------------------------------------------------------------------------%
[Spectrum_waveform,Welch_Spectrum_frequency] = pwelch(RX,[],[],[],(1/Ts)*4,'centered','power');
subplot(2,3,3),plot(Welch_Spectrum_frequency,pow2db(Spectrum_waveform));
title('Welch Power Spectral Density');
%--------------------------------------------------------------------------------%
subplot(2,3,4),plot(abs(H_est));title('Channel Estimation');axis([1 512 -0.5 6]);xlabel('subcarrier');
%--------------------------------------------------------------------------------%
subplot(2,3,5),plot(RX_no_Equalizer,'*');
title('Before Equalizer and pilot correction');%axis([-1.5 1.5 -1.5 1.5]);
%--------------------------------------------------------------------------------%
subplot(2,3,6);
%figure;
plot(RX_payload,'*');
title({'Demodulation';['BER = ',num2str(BER)]});axis([-1.5 1.5 -1.5 1.5]);
hold off